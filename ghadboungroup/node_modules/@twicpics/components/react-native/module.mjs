import e,{useState as t,useEffect as o,useRef as n}from"react";import{Easing as i,PixelRatio as r,StyleSheet as a,View as s,Platform as c,Image as l,Dimensions as d,Animated as u}from"react-native";const m=e=>`twicpics-components ${e}`,h="undefined"!=typeof document,p=()=>{},g=(e,{filter:t,defaultValue:o}={})=>n=>{let i;return n&&`${n}`.replace(e,((e,t)=>i=t)),(t?t(i):i)||o},f=e=>{throw new Error(m(e))},v=(e,{border:t="\\s",regExpFlags:o}={})=>new RegExp(`^(?:${t})*(${Array.isArray(e)?e.join("|"):e})(?:${t})*$`,o),$={breakpoints:{xs:320,sm:640,md:768,lg:1024,xl:1280,"2xl":1536},class:"twic",domain:void 0,env:"production",handleShadowDom:p,maxDPR:void 0,path:"",step:void 0},y=h&&window,w=h?y["~ TPCC"]||(y["~ TPCC"]=$):$,b=/^(?:(auth|placeholder|rel)|(image|media|video)|[^:]*):(\/*)((v[0-9]+(?=[/?]))?[^?]*(\?.*)?)$/,x=(e,t="")=>{const o=e&&b.exec(e);return{isAbsolute:e.slice(0,t.length+1)===`${t}/`,isSpecial:o&&void 0!==o[1]}},O=["center"];for(const e of["","bottom","top"])for(const t of["","left","right"])(t||e)&&O.push(e?t?`${e}-${t}`:e:t);const V=/\?|^\/*$/;v(O);const I=/(^https?:\/\/[^/]+)\/*$/;v(["high","low","auto"]),v("\\s*(\\d+)\\s*[x]\\s*(\\d+)\\s*");const E=v(["contain","cover"]),P=v(["maincolor","meancolor","none","preview"]),T=/^\/*(.+?)\/*$/,D=v("(\\d+(?:\\.\\d+)?)(?:\\s*[\\/:]\\s*(\\d+(?:\\.\\d+)?))?|(none)"),S=v(["debug","offline","production"]);v("(\\d+\\.?\\d*)|(css)",{regExpFlags:"i"});const j=e=>!isNaN(e)&&e>0,M=/^((image|media|video):)?\/*/,L=g(v("(?:.|\n)+?")),R=v(".+?",{border:"[\\s\\/]"}),z={true:!0,false:!1,"":!0},C=e=>"boolean"==typeof e?e:void 0!==e&&z[e.trim()],F=e=>{if("number"!=typeof e){const t=L(e);e=t&&Number(t)}return j(e)?e:void 0},N=/\b(?:(left|right)|(bottom|top))\b/g,k=e=>{const t=L(e);return I.test(t)?t.replace(I,"$1"):void 0},A=F,q=C,W=g(S),H=F,J=g(E,{defaultValue:"cover"}),B=e=>{const t=L(e);return t?t.replace(T,"$1/"):""},G=g(R,{filter:e=>e&&e.replace(/^\/*(.*[^/])\/*$/,"$1")}),K=F,Q=F,U={true:"fade",false:"none",fade:"fade",zoom:"zoom",none:"none"},X=L,Y=L,Z={center:"contain-max",cover:"cover",contain:"contain",stretch:"resize",repeat:"contain-max"},_=(e,t)=>{if(t){let o=e||{};return Array.isArray(e)&&(o=e.reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{})),o=JSON.parse(JSON.stringify(o)),o.height=void 0,o.aspectRatio=1/t,o}return e},ee={left:"flex-start",right:"flex-end",top:"flex-start",bottom:"flex-end"},te=(e,t)=>{if("contain"===t){const{x:t,y:o}=e;return{alignItems:ee[t]||"center",justifyContent:ee[o]||"center"}}return{}},oe=({toValue:e,transitionDelay:t,transitionDuration:o,transitionTimingFunction:n})=>({delay:Number(t||0),duration:Number(o||200),easing:n||i.ease,toValue:e,useNativeDriver:!0}),ne=({anchor:e,focus:t,inspect:o=!1,mode:n,placeholder:i,poster:a,preTransform:s,refit:c,src:l,step:d,viewSize:u,videoOptions:m})=>{const{domain:h}=w,p=o&&!x(l).isSpecial,{width:g,height:f}=((e,t,o)=>{const n=Math.min(Math.max(1,r.get()),w.maxDPR);let i=(t=>{const o=e||w.step;return Math.max(o,o*Math.floor(t/o))})(o.width*n),a=o.ratio?i*o.ratio:o.height*n;if(t){const e=i/a;i=a=1e3,e>1?a=Math.floor(a/e):i=Math.floor(i*e)}return{width:Math.round(i),height:Math.round(a)}})(d,p,u),{posterTransform:v,videoTransform:$}=m||{},y={height:f,mode:Z[n],width:g},O=(a?"image":p?i:"")||"",V=(a?v:$)||"",I=`${(({anchor:{x:e,y:t},debug:o,focus:n,mode:i,preTransform:r,refit:a})=>{const s=t?e?`${t}-${e}`:t:e,c="contain"!==i&&void 0===a&&(n||s),l=((e,t,o)=>void 0!==o&&`${"contain"===t?"auto":"WxH"}${o?`(${o})`:""}${e&&"contain"!==t?`@${e}`:""}`)(s,i,a);return`${o?"/debug":""}${r?`/${r}`:""}${c?`/focus=${c}`:""}${l?`/refit=${l}`:""}`})({anchor:e,focus:t,mode:n,preTransform:s,refit:c})}${V}${((e,t)=>"cover"===e&&void 0!==t?"":"/*")(n,c)||""}`;return(({domain:e,context:t,inspect:o,output:n,quality:i,src:r,transform:a})=>{const{isAbsolute:s}=x(r,e),c=s?`media:${r.slice(`${e}/`.length)}`:r,l=b.exec(c),d=l&&l[2],u=n?`/output=${n}`:"",m=d?l[4]:c,h=i?`/quality=${i}`:"",p=o?"/inspect":"",g=(({height:e,mode:t,width:o},n)=>{if(n&&(o||e)){const i=e||"-",r=o||"-";return n.replace(/(\/*\*)/g,`/${t}=${r}x${i}`).replace(/WxH/g,`${r}x${i}`)}return n})(t,a);return`${e}/${l&&(l[1]||l[5])?`v1${g}${u}${h}${p}/${d?`${l[2]}:${m}`:m}`:`${m}${l&&l[6]?"&":"?"}twic=v1${g}${u}${p}${h}`}`})({context:y,domain:h,inspect:o,transform:I,src:l,output:O})},ie=(e,t)=>{if(e){const{ratioIntrinsic:o}=e,n=t.width/t.height;return Math.max(1,Math.round(o>n?t.width:t.height*o))}return 0},re=g(v(["disk","memory","memory-disk","none"])),ae=a.create({asset:{position:"absolute",top:0,right:0,bottom:0,left:0},container:{overflow:"hidden",width:"100%"},layout:{flex:1,flexDirection:"column",overflow:"hidden"}});var se=t=>{const{ratio:o=1,style:n}=t,i=(e=>{if("none"===e)return 0;let t;if(e)if("number"==typeof e)t=1/e;else{const o=D.exec(e);if(o){const[,,e,n]=o;t=(n?Number(n):1)/Number(e)}else t=1}return j(t)?t:void 0})(o);return e.createElement(s,{onLayout:e=>{const{width:o,height:n}=e.nativeEvent.layout,r=((e,t,o)=>({height:o?e*o:t,ratio:o||(e?t/e:void 0),width:e}))(o,n,i);o>0&&n>0&&t.onLayout(r)},style:a.flatten([ae.container,_(n,i)])},t.children)};const ce=(e,t)=>e.uri===t.uri;var le=e.memo((({alt:t,uri:o,onLoad:n})=>o&&e.createElement(l,{alt:t,onLoad:n,source:{uri:o},style:[ae.asset]})),ce);const de={Image:"Image Caching requires 'expo' and 'expo-image' dependencies. For more information, refer to the documentation: https://www.twicpics.com/docs/components/react-native",Video:"TwicVideo requires 'expo' and 'expo-av' dependencies. For more information, refer to the documentation: https://www.twicpics.com/docs/components/react-native"},ue={};var me=e=>{const[n,i]=t({});return o((()=>{var t;("Image"===e&&void 0===ue.Image||"Video"===e&&void 0===ue.Video)&&((e=>{try{const{Image:t,Video:o}=require("expo-av");ue.Video=o||("Video"===e?null:o),ue.Image=t}catch(t){ue.Image="Image"===e?null:void 0,ue.Video="Video"===e?null:void 0}})(e),(e=>{if("Image"===e&&void 0===ue.Image)try{const{Image:e}=require("expo-image");ue.Image=e}catch(e){ue.Image=null}})(e),ue[e]||(t=de[e],console.warn(m(t)))),i(ue)}),[]),n},he=e.memo((({alt:t,cachePolicy:o,uri:n,onLoad:i})=>{const{Image:r}=me("Image");return n&&r&&e.createElement(r,{alt:t,cachePolicy:o,onLoad:i,source:{uri:n},style:[ae.asset]})}),ce),pe=e.memo((({onLoad:t,poster:o,uri:n})=>{const{Video:i}=me("Video");return n&&i&&e.createElement(i,{isLooping:!0,isMuted:!0,onReadyForDisplay:t,PosterComponent:()=>e.createElement(l,{onLoad:t,source:{uri:o},style:[ae.asset]}),resizeMode:"cover",shouldPlay:!0,source:{uri:n},style:[ae.asset],usePoster:!0,videoStyle:{width:"100%",height:"100%"}})}),ce);const ge=t=>{const{eager:i,children:r,measurementInterval:a,onVisibilityChanged:c}=t,{anticipation:l}=w,u=n(null),m=n(null),h=()=>{if(!(null==u?void 0:u.current))return;const e=d.get("window");u.current.measure(((t,o,n,i,r,a)=>{if(0===i)return;const s=a,d=a+i,u=r+n,m=r,h=l*e.height*-1,g=e.height*(1+l),f=l*e.width*-1,v=e.width*(1+l);d>=h&&s<=g&&u>=f&&m<=v&&(c(!0),p())}))},p=()=>{(null==m?void 0:m.current)&&(clearInterval(m.current),m.current=null)};return o((()=>{if(!i)return(null==m?void 0:m.current)||(h(),m.current=setInterval((()=>{h()}),a||100)),p;c(!0)}),[]),e.createElement(s,{collapsable:!1,ref:u,style:{flex:1}},r)};var fe=r=>{const{mediaTag:a,videoOptions:l,viewSize:d}=r,m=(h=r.alt,L(h)||"");var h;const p=(e=>{const t=L(e);let o,n;if(t){let e;for(;e=N.exec(t);)e[1]?o=e[1]:n=e[2]}return{x:o,y:n}})(r.anchor),g=re(r.cachePolicy)||w.cachePolicy,f=q(r.eager),v=(e=>{const t=L(e);return"none"===t?void 0:t})(r.focus),$=J(r.mode),y=(e=>{if("offline"!==w.env&&"none"!==e)return P.test(e)?e:"preview"})(r.placeholder),b=G(r.preTransform),O=(e=>{const t=C(e);if(void 0===t){const t=L((e||"").toString());return t&&t.replace(/\s/g,"")}return t?"":void 0})(r.refit),V=(e=>{w.env;const t=L(e)||"placeholder:red",{isAbsolute:o,isSpecial:n}=x(t,w.domain);return n?t:o?`media:${t.slice(`${w.domain}/`.length)}`:t.replace(M,`media:${w.path}`)})(r.src),I=K(r.step),E=(e=>{"boolean"!=typeof e&&(e=L(e)||!0);const t={};return String(e).split(/\s*\+\s*|\s+/).forEach((e=>t[`${U[e]||"fade"}`]=!0)),t})(r.transition),T=X(r.transitionDelay),D=Y(r.transitionDuration),S=(e=>e||i.ease)(r.transitionTimingFunction),j="img"===a?"none"===g?le:he:pe,R=((e,t)=>"img"===t?e:void 0)(m,a),{media:z,inspect:F,poster:k}=((e,t)=>({media:ne(t),inspect:ne(Object.assign(Object.assign({},t),{inspect:!0})),poster:e&&ne(Object.assign(Object.assign({},t),{poster:!0}))}))(a,{anchor:p,focus:v,mode:$,placeholder:y,preTransform:b,refit:O,src:V,step:I,videoOptions:l,viewSize:d}),A=n(new u.Value(0)).current,W=n(new u.Value(E.hasOwnProperty("zoom")?0:1)).current,[H,B]=t(void 0),[Q,Z]=t(void 0),[_,ee]=t(!1),se=n(((e,t)=>{let o;const n=Object.assign({leading:!0,ms:0,trailing:!0},{leading:!1,ms:100,trailing:!0});return(...t)=>{!o&&n.leading&&e(...t),clearTimeout(o),o=setTimeout((()=>{o=void 0,n.trailing&&e(...t)}),n.ms)}})((e=>{A.setValue(E.hasOwnProperty("fade")?1:0),B(e),"debug"===w.env&&console.debug("Displaying: ",e)}))).current;return o((()=>{_&&se(z)}),[z,_]),o((()=>{(async()=>{A.setValue(E.hasOwnProperty("fade")?1:0),Z(await(async(e,t)=>{let o;try{const t=await fetch(e);o=await t.json()}catch(e){}const{output:{color:n,image:i,height:r,intrinsicWidth:a,width:s}}=o||{output:{}},l=i?s/(2*a):0;return((e,t)=>{const{height:o,width:n,placeholder:i}=e;return{placeholder:i,ratioIntrinsic:o?n/o:1/t.ratio}})({placeholder:n||i?{blurRadius:"web"===c.OS?l:5,color:n,offset:"web"===c.OS?-1*l:0,uri:i}:void 0,width:s,height:r},t)})(F,d))})()}),[F]),e.createElement(ge,{eager:f,onVisibilityChanged:()=>{ee(!0)}},e.createElement(u.View,{style:[ae.layout,te(p,$),{transform:[{scale:W}]}]},e.createElement(s,{style:{aspectRatio:null==Q?void 0:Q.ratioIntrinsic,overflow:"hidden",width:ie(Q,d)}},e.createElement(j,{alt:R,cachePolicy:g,onLoad:()=>{E.hasOwnProperty("none")?A.setValue(0):(u.timing(A,oe({toValue:0,transitionDelay:T,transitionDuration:D,transitionTimingFunction:S})).start(),u.timing(W,oe({toValue:1,transitionDelay:T,transitionDuration:D,transitionTimingFunction:S})).start())},uri:H,poster:k}),(null==Q?void 0:Q.placeholder)&&e.createElement(u.Image,{blurRadius:Q.placeholder.blurRadius||0,style:[ae.asset,{backgroundColor:Q.placeholder.color,margin:Q.placeholder.offset,opacity:A}],source:{uri:null==Q?void 0:Q.placeholder.uri}}))))};const ve=o=>{const[n,i]=t(void 0);return e.createElement(se,{onLayout:e=>{i(e)},ratio:o.ratio,style:o.style},n&&e.createElement(fe,Object.assign({},o,{mediaTag:"img",viewSize:n})))},$e=o=>{const[n,i]=t(void 0),r=(a=A(o.duration),s=H(o.from),c=H(o.posterFrom),{videoTransform:`${s?`/from=${s}`:""}${(l=Q(o.to))?`/to=${l}`:""}${a?`/duration=${a}`:""}`,posterTransform:c||s?`/from=${void 0===c?s:c}`:""});var a,s,c,l;return e.createElement(se,{onLayout:e=>{i(e)},ratio:o.ratio,style:o.style},n&&e.createElement(fe,Object.assign({},o,{mediaTag:"video",viewSize:n,videoOptions:r})))},ye=.2;var we=e=>{const{anticipation:t=ye,cachePolicy:o,step:n}=e;(e=>{(e=>{e||f("install options not provided");const{domain:t,env:o,path:n}=e;t&&I.test(t)||f(`install domain "${t}" is invalid`),n&&V.test(n)&&f(`install path "${n}" is invalid`),o&&!S.test(o)&&f(`install env "${o}" is invalid`)})(e);const{domain:t,env:o,path:n}=e;(e=>{const{breakpoints:t={},debug:o,domain:n,class:i,env:r,handleShadowDom:a,maxDPR:s,path:c}=e;w.breakpoints=Object.assign(Object.assign({},w.breakpoints),t),w.class=i||w.class,w.domain=n,w.env=o?"debug":r,w.maxDPR=Math.max(1,s||2),w.path=c,w.handleShadowDom=p})(Object.assign(Object.assign({},e),{domain:k(t),env:W(o),path:B(n)}))})(Object.assign({maxDPR:2},e)),w.anticipation=t,w.step=n||10,w.cachePolicy=o||"none"};const be=we;export{ve as TwicImg,$e as TwicVideo,we as installTwicPics,be as installTwicpics};
