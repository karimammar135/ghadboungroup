"use strict";var e=require("react"),t=require("react-native");const o=e=>`twicpics-components ${e}`,i="undefined"!=typeof document,n=()=>{},r=(e,{filter:t,defaultValue:o}={})=>i=>{let n;return i&&`${i}`.replace(e,((e,t)=>n=t)),(t?t(n):n)||o},a=e=>{throw new Error(o(e))},s=(e,{border:t="\\s",regExpFlags:o}={})=>new RegExp(`^(?:${t})*(${Array.isArray(e)?e.join("|"):e})(?:${t})*$`,o),c={breakpoints:{xs:320,sm:640,md:768,lg:1024,xl:1280,"2xl":1536},class:"twic",domain:void 0,env:"production",handleShadowDom:n,maxDPR:void 0,path:"",step:void 0},l=i&&window,d=i?l["~ TPCC"]||(l["~ TPCC"]=c):c,u=/^(?:(auth|placeholder|rel)|(image|media|video)|[^:]*):(\/*)((v[0-9]+(?=[/?]))?[^?]*(\?.*)?)$/,m=(e,t="")=>{const o=e&&u.exec(e);return{isAbsolute:e.slice(0,t.length+1)===`${t}/`,isSpecial:o&&void 0!==o[1]}},h=["center"];for(const e of["","bottom","top"])for(const t of["","left","right"])(t||e)&&h.push(e?t?`${e}-${t}`:e:t);const p=/\?|^\/*$/;s(h);const f=/(^https?:\/\/[^/]+)\/*$/;s(["high","low","auto"]),s("\\s*(\\d+)\\s*[x]\\s*(\\d+)\\s*");const g=s(["contain","cover"]),v=s(["maincolor","meancolor","none","preview"]),$=/^\/*(.+?)\/*$/,w=s("(\\d+(?:\\.\\d+)?)(?:\\s*[\\/:]\\s*(\\d+(?:\\.\\d+)?))?|(none)"),y=s(["debug","offline","production"]);s("(\\d+\\.?\\d*)|(css)",{regExpFlags:"i"});const b=e=>!isNaN(e)&&e>0,x=/^((image|media|video):)?\/*/,V=r(s("(?:.|\n)+?")),S=s(".+?",{border:"[\\s\\/]"}),E={true:!0,false:!1,"":!0},I=e=>"boolean"==typeof e?e:void 0!==e&&E[e.trim()],O=e=>{if("number"!=typeof e){const t=V(e);e=t&&Number(t)}return b(e)?e:void 0},P=/\b(?:(left|right)|(bottom|top))\b/g,T=e=>{const t=V(e);return f.test(t)?t.replace(f,"$1"):void 0},D=O,R=I,j=r(y),A=O,M=r(g,{defaultValue:"cover"}),L=e=>{const t=V(e);return t?t.replace($,"$1/"):""},z=r(S,{filter:e=>e&&e.replace(/^\/*(.*[^/])\/*$/,"$1")}),C=O,F=O,N={true:"fade",false:"none",fade:"fade",zoom:"zoom",none:"none"},q=V,k=V,W={center:"contain-max",cover:"cover",contain:"contain",stretch:"resize",repeat:"contain-max"},H=(e,t)=>{if(t){let o=e||{};return Array.isArray(e)&&(o=e.reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{})),o=JSON.parse(JSON.stringify(o)),o.height=void 0,o.aspectRatio=1/t,o}return e},J={left:"flex-start",right:"flex-end",top:"flex-start",bottom:"flex-end"},B=(e,t)=>{if("contain"===t){const{x:t,y:o}=e;return{alignItems:J[t]||"center",justifyContent:J[o]||"center"}}return{}},G=({toValue:e,transitionDelay:o,transitionDuration:i,transitionTimingFunction:n})=>({delay:Number(o||0),duration:Number(i||200),easing:n||t.Easing.ease,toValue:e,useNativeDriver:!0}),K=({anchor:e,focus:o,inspect:i=!1,mode:n,placeholder:r,poster:a,preTransform:s,refit:c,src:l,step:h,viewSize:p,videoOptions:f})=>{const{domain:g}=d,v=i&&!m(l).isSpecial,{width:$,height:w}=((e,o,i)=>{const n=Math.min(Math.max(1,t.PixelRatio.get()),d.maxDPR);let r=(t=>{const o=e||d.step;return Math.max(o,o*Math.floor(t/o))})(i.width*n),a=i.ratio?r*i.ratio:i.height*n;if(o){const e=r/a;r=a=1e3,e>1?a=Math.floor(a/e):r=Math.floor(r*e)}return{width:Math.round(r),height:Math.round(a)}})(h,v,p),{posterTransform:y,videoTransform:b}=f||{},x={height:w,mode:W[n],width:$},V=(a?"image":v?r:"")||"",S=(a?y:b)||"",E=`${(({anchor:{x:e,y:t},debug:o,focus:i,mode:n,preTransform:r,refit:a})=>{const s=t?e?`${t}-${e}`:t:e,c="contain"!==n&&void 0===a&&(i||s),l=((e,t,o)=>void 0!==o&&`${"contain"===t?"auto":"WxH"}${o?`(${o})`:""}${e&&"contain"!==t?`@${e}`:""}`)(s,n,a);return`${o?"/debug":""}${r?`/${r}`:""}${c?`/focus=${c}`:""}${l?`/refit=${l}`:""}`})({anchor:e,focus:o,mode:n,preTransform:s,refit:c})}${S}${((e,t)=>"cover"===e&&void 0!==t?"":"/*")(n,c)||""}`;return(({domain:e,context:t,inspect:o,output:i,quality:n,src:r,transform:a})=>{const{isAbsolute:s}=m(r,e),c=s?`media:${r.slice(`${e}/`.length)}`:r,l=u.exec(c),d=l&&l[2],h=i?`/output=${i}`:"",p=d?l[4]:c,f=n?`/quality=${n}`:"",g=o?"/inspect":"",v=(({height:e,mode:t,width:o},i)=>{if(i&&(o||e)){const n=e||"-",r=o||"-";return i.replace(/(\/*\*)/g,`/${t}=${r}x${n}`).replace(/WxH/g,`${r}x${n}`)}return i})(t,a);return`${e}/${l&&(l[1]||l[5])?`v1${v}${h}${f}${g}/${d?`${l[2]}:${p}`:p}`:`${p}${l&&l[6]?"&":"?"}twic=v1${v}${h}${g}${f}`}`})({context:x,domain:g,inspect:i,transform:E,src:l,output:V})},Q=(e,t)=>{if(e){const{ratioIntrinsic:o}=e,i=t.width/t.height;return Math.max(1,Math.round(o>i?t.width:t.height*o))}return 0},U=r(s(["disk","memory","memory-disk","none"])),X=t.StyleSheet.create({asset:{position:"absolute",top:0,right:0,bottom:0,left:0},container:{overflow:"hidden",width:"100%"},layout:{flex:1,flexDirection:"column",overflow:"hidden"}});var Y=o=>{const{ratio:i=1,style:n}=o,r=(e=>{if("none"===e)return 0;let t;if(e)if("number"==typeof e)t=1/e;else{const o=w.exec(e);if(o){const[,,e,i]=o;t=(i?Number(i):1)/Number(e)}else t=1}return b(t)?t:void 0})(i);return e.createElement(t.View,{onLayout:e=>{const{width:t,height:i}=e.nativeEvent.layout,n=((e,t,o)=>({height:o?e*o:t,ratio:o||(e?t/e:void 0),width:e}))(t,i,r);t>0&&i>0&&o.onLayout(n)},style:t.StyleSheet.flatten([X.container,H(n,r)])},o.children)};const Z=(e,t)=>e.uri===t.uri;var _=e.memo((({alt:o,uri:i,onLoad:n})=>i&&e.createElement(t.Image,{alt:o,onLoad:n,source:{uri:i},style:[X.asset]})),Z);const ee={Image:"Image Caching requires 'expo' and 'expo-image' dependencies. For more information, refer to the documentation: https://www.twicpics.com/docs/components/react-native",Video:"TwicVideo requires 'expo' and 'expo-av' dependencies. For more information, refer to the documentation: https://www.twicpics.com/docs/components/react-native"},te={};var oe=t=>{const[i,n]=e.useState({});return e.useEffect((()=>{var e;("Image"===t&&void 0===te.Image||"Video"===t&&void 0===te.Video)&&((e=>{try{const{Image:t,Video:o}=require("expo-av");te.Video=o||("Video"===e?null:o),te.Image=t}catch(t){te.Image="Image"===e?null:void 0,te.Video="Video"===e?null:void 0}})(t),(e=>{if("Image"===e&&void 0===te.Image)try{const{Image:e}=require("expo-image");te.Image=e}catch(e){te.Image=null}})(t),te[t]||(e=ee[t],console.warn(o(e)))),n(te)}),[]),i},ie=e.memo((({alt:t,cachePolicy:o,uri:i,onLoad:n})=>{const{Image:r}=oe("Image");return i&&r&&e.createElement(r,{alt:t,cachePolicy:o,onLoad:n,source:{uri:i},style:[X.asset]})}),Z),ne=e.memo((({onLoad:o,poster:i,uri:n})=>{const{Video:r}=oe("Video");return n&&r&&e.createElement(r,{isLooping:!0,isMuted:!0,onReadyForDisplay:o,PosterComponent:()=>e.createElement(t.Image,{onLoad:o,source:{uri:i},style:[X.asset]}),resizeMode:"cover",shouldPlay:!0,source:{uri:n},style:[X.asset],usePoster:!0,videoStyle:{width:"100%",height:"100%"}})}),Z);const re=o=>{const{eager:i,children:n,measurementInterval:r,onVisibilityChanged:a}=o,{anticipation:s}=d,c=e.useRef(null),l=e.useRef(null),u=()=>{if(!(null==c?void 0:c.current))return;const e=t.Dimensions.get("window");c.current.measure(((t,o,i,n,r,c)=>{if(0===n)return;const l=c,d=c+n,u=r+i,h=r,p=s*e.height*-1,f=e.height*(1+s),g=s*e.width*-1,v=e.width*(1+s);d>=p&&l<=f&&u>=g&&h<=v&&(a(!0),m())}))},m=()=>{(null==l?void 0:l.current)&&(clearInterval(l.current),l.current=null)};return e.useEffect((()=>{if(!i)return(null==l?void 0:l.current)||(u(),l.current=setInterval((()=>{u()}),r||100)),m;a(!0)}),[]),e.createElement(t.View,{collapsable:!1,ref:c,style:{flex:1}},n)};var ae=o=>{const{mediaTag:i,videoOptions:n,viewSize:r}=o,a=(s=o.alt,V(s)||"");var s;const c=(e=>{const t=V(e);let o,i;if(t){let e;for(;e=P.exec(t);)e[1]?o=e[1]:i=e[2]}return{x:o,y:i}})(o.anchor),l=U(o.cachePolicy)||d.cachePolicy,u=R(o.eager),h=(e=>{const t=V(e);return"none"===t?void 0:t})(o.focus),p=M(o.mode),f=(e=>{if("offline"!==d.env&&"none"!==e)return v.test(e)?e:"preview"})(o.placeholder),g=z(o.preTransform),$=(e=>{const t=I(e);if(void 0===t){const t=V((e||"").toString());return t&&t.replace(/\s/g,"")}return t?"":void 0})(o.refit),w=(e=>{d.env;const t=V(e)||"placeholder:red",{isAbsolute:o,isSpecial:i}=m(t,d.domain);return i?t:o?`media:${t.slice(`${d.domain}/`.length)}`:t.replace(x,`media:${d.path}`)})(o.src),y=C(o.step),b=(e=>{"boolean"!=typeof e&&(e=V(e)||!0);const t={};return String(e).split(/\s*\+\s*|\s+/).forEach((e=>t[`${N[e]||"fade"}`]=!0)),t})(o.transition),S=q(o.transitionDelay),E=k(o.transitionDuration),O=(e=>e||t.Easing.ease)(o.transitionTimingFunction),T="img"===i?"none"===l?_:ie:ne,D=((e,t)=>"img"===t?e:void 0)(a,i),{media:j,inspect:A,poster:L}=((e,t)=>({media:K(t),inspect:K(Object.assign(Object.assign({},t),{inspect:!0})),poster:e&&K(Object.assign(Object.assign({},t),{poster:!0}))}))(i,{anchor:c,focus:h,mode:p,placeholder:f,preTransform:g,refit:$,src:w,step:y,videoOptions:n,viewSize:r}),F=e.useRef(new t.Animated.Value(0)).current,W=e.useRef(new t.Animated.Value(b.hasOwnProperty("zoom")?0:1)).current,[H,J]=e.useState(void 0),[Y,Z]=e.useState(void 0),[ee,te]=e.useState(!1),oe=e.useRef(((e,t)=>{let o;const i=Object.assign({leading:!0,ms:0,trailing:!0},{leading:!1,ms:100,trailing:!0});return(...t)=>{!o&&i.leading&&e(...t),clearTimeout(o),o=setTimeout((()=>{o=void 0,i.trailing&&e(...t)}),i.ms)}})((e=>{F.setValue(b.hasOwnProperty("fade")?1:0),J(e),"debug"===d.env&&console.debug("Displaying: ",e)}))).current;return e.useEffect((()=>{ee&&oe(j)}),[j,ee]),e.useEffect((()=>{(async()=>{F.setValue(b.hasOwnProperty("fade")?1:0),Z(await(async(e,o)=>{let i;try{const t=await fetch(e);i=await t.json()}catch(e){}const{output:{color:n,image:r,height:a,intrinsicWidth:s,width:c}}=i||{output:{}},l=r?c/(2*s):0;return((e,t)=>{const{height:o,width:i,placeholder:n}=e;return{placeholder:n,ratioIntrinsic:o?i/o:1/t.ratio}})({placeholder:n||r?{blurRadius:"web"===t.Platform.OS?l:5,color:n,offset:"web"===t.Platform.OS?-1*l:0,uri:r}:void 0,width:c,height:a},o)})(A,r))})()}),[A]),e.createElement(re,{eager:u,onVisibilityChanged:()=>{te(!0)}},e.createElement(t.Animated.View,{style:[X.layout,B(c,p),{transform:[{scale:W}]}]},e.createElement(t.View,{style:{aspectRatio:null==Y?void 0:Y.ratioIntrinsic,overflow:"hidden",width:Q(Y,r)}},e.createElement(T,{alt:D,cachePolicy:l,onLoad:()=>{b.hasOwnProperty("none")?F.setValue(0):(t.Animated.timing(F,G({toValue:0,transitionDelay:S,transitionDuration:E,transitionTimingFunction:O})).start(),t.Animated.timing(W,G({toValue:1,transitionDelay:S,transitionDuration:E,transitionTimingFunction:O})).start())},uri:H,poster:L}),(null==Y?void 0:Y.placeholder)&&e.createElement(t.Animated.Image,{blurRadius:Y.placeholder.blurRadius||0,style:[X.asset,{backgroundColor:Y.placeholder.color,margin:Y.placeholder.offset,opacity:F}],source:{uri:null==Y?void 0:Y.placeholder.uri}}))))};const se=.2;var ce=e=>{const{anticipation:t=se,cachePolicy:o,step:i}=e;(e=>{(e=>{e||a("install options not provided");const{domain:t,env:o,path:i}=e;t&&f.test(t)||a(`install domain "${t}" is invalid`),i&&p.test(i)&&a(`install path "${i}" is invalid`),o&&!y.test(o)&&a(`install env "${o}" is invalid`)})(e);const{domain:t,env:o,path:i}=e;(e=>{const{breakpoints:t={},debug:o,domain:i,class:r,env:a,handleShadowDom:s,maxDPR:c,path:l}=e;d.breakpoints=Object.assign(Object.assign({},d.breakpoints),t),d.class=r||d.class,d.domain=i,d.env=o?"debug":a,d.maxDPR=Math.max(1,c||2),d.path=l,d.handleShadowDom=n})(Object.assign(Object.assign({},e),{domain:T(t),env:j(o),path:L(i)}))})(Object.assign({maxDPR:2},e)),d.anticipation=t,d.step=i||10,d.cachePolicy=o||"none"};const le=ce;exports.TwicImg=t=>{const[o,i]=e.useState(void 0);return e.createElement(Y,{onLayout:e=>{i(e)},ratio:t.ratio,style:t.style},o&&e.createElement(ae,Object.assign({},t,{mediaTag:"img",viewSize:o})))},exports.TwicVideo=t=>{const[o,i]=e.useState(void 0),n=(r=D(t.duration),a=A(t.from),s=A(t.posterFrom),{videoTransform:`${a?`/from=${a}`:""}${(c=F(t.to))?`/to=${c}`:""}${r?`/duration=${r}`:""}`,posterTransform:s||a?`/from=${void 0===s?a:s}`:""});var r,a,s,c;return e.createElement(Y,{onLayout:e=>{i(e)},ratio:t.ratio,style:t.style},o&&e.createElement(ae,Object.assign({},t,{mediaTag:"video",viewSize:o,videoOptions:n})))},exports.installTwicPics=ce,exports.installTwicpics=le;
